# Сервис событий
Используется для рассылки событий между сервисами. Позволяет любым сервисам подписываться на события других сервисов и рассылать собственные события.

- Сервис не гарантирует **последовательность доставки** событий в том виде, в котором они были вызваны. Для слушателя, событие `B` может предшествовать событию: `A`.
- Сервис гарантирует **разовую отправку** события. Слушатель никогда не получит одно и то же событие более одного раза.

## REST JSON API
|Тип|URL|Описание|
|:-|:-|:-|
|`GET`|[/listener](#Список-слушателей)|Получить список всех слушателей в данный момент. Может быть полезно для отладки или диагностики работы сервиса.|
|`POST`|[/on](#Подписка-на-события)|Подписаться на получение события.|
|`POST`|[/once](#Разовая-подписка-на-событие)|Подписаться на разовое получение события. Отличается от обычной подписки только тем, что после первого события подписка автоматически удаляется.|
|`POST`|[/off](#Отмена-подписки)|Отменить подписку на событие.|
|`GET`|[/has](#Проверка-наличия-слушателя)|Проверить наличие слушателя для указанного события.|
|`POST`|[/emit](#Рассылка-события)|Послать новое событие всем подписчикам.|

## Конфигурация сервиса
Конфигурация сервиса производится администратором через переменные окружения, в котором запущен сервис. Регистр имеет значение.
|Переменная|Значение по умолчанию|Описание|
|:-|:-|:-|
|`LOG_LEVEL`|`TRACE`|Определяет уровни серьезности для ведения журнала. По умолчанию выводится всё.|
|`CALLBACK_MAX_CALLS`|`100`|Количество повторных попыток вызова слушателя, если он не доступен. Если: `0` - повторные попытки не выполняются. Если меньше: `0` - количество попыток не ограничено.|
|`CALLBACK_TIMEOUT`|`86 400 000`|Таймаут для попыток обратного вызова в миллисекундах. По умолчанию сутки: `1000*60*60*24`. Если равно: `0` или меньше, таймаут для повторных попыток отправки не используется.|

### Повторные попытки вызова
Слушатель считается успешно вызванным, если он вернул код статуса из диапазона: [2xx](https://ru.wikipedia.org/wiki/%D0%A1%D0%BF%D0%B8%D1%81%D0%BE%D0%BA_%D0%BA%D0%BE%D0%B4%D0%BE%D0%B2_%D1%81%D0%BE%D1%81%D1%82%D0%BE%D1%8F%D0%BD%D0%B8%D1%8F_HTTP#2xx). Во всех остальных случаях будет производиться повторная попытка уведомления через каждые: `0.5`, `1`, `2`, `5` и далее через каждые `10` секунд до тех пор, пока:
- Не будет достигнут лимит на количество повторных попыток вызова: `CALLBACK_MAX_CALLS`.
- Не истечёт таймаут для попыток обратного вызова: `CALLBACK_TIMEOUT`.
- Слушатель вернул код HTTP статуса: `2xx`.

*п.с. Таймаут и ограничение повторных вызовов нужны для исключения возможности переполнения памяти зависшими или мёртвыми слушателями.*

### Логирование
|Обозначение|Код|Описание|
|:-|:-:|:-|
|`TRACE`|`0`|Журналы, содержащие наиболее подробные сообщения. Эти сообщения могут содержать конфиденциальные данные приложения, их никогда не следует включать в рабочей среде.|
|`DEBUG`|`1`|Журналы, используемые для интерактивного исследования во время разработки. Эти журналы в основном содержат сведения, полезные при отладки и не представляющие ценности в долгосрочной перспективе.|
|`INFO`|`2`|Журналы, отслеживающие общий поток работы приложения. Эти журналы должны быть полезны в долгосрочной перспективе.|
|`WARNING`|`3`|Журналы, которые показывают ненормальное или неожиданное событие в потоке приложения, но не вызывают прекращение выполнения приложения каким-либо образом.|
|`ERROR`|`4`|Журналы, показывающие, когда текущий поток выполнения останавливается из-за сбоя. Эти элементы должны указывать на сбой текущего действия, а не ошибку уровня приложения.|
|`CRITICAL`|`5`|Журналы, описывающие неустранимый сбой приложения или системы либо неустранимый сбой, который требует немедленного внимания.|

## Пример ответа
Ответ сервера всегда передаётся в формате данных JSON.
Базовая структура ответа:
```
{
    "success": true,
    "results": ...,
    "error": ...
}
```

- `success` Флаг результата обращения к API. Всегда присутствует в ответе сервера.
  - Если `true`, запрос был успешно обработан. Результат выполнения доступен в поле `results`.
  - Если `false`, запрос был отклонён. В этом случае всегда отправляется поле `error` с описанием причины ошибки. (Описание ошибки смотрите ниже)
- `results` Результат выполнения запроса. Содержится для успешных запросов, если метод API предполагает отправку данных. Тип содержимого зависит от конкретного, вызываемого метода API.
- `error` Описание ошибки. Отправляется для неудачных запросов с `success=false`. Содержит описание ошибки.

## Ошибки
Сервис может вернуть ошибку, если ему не удалось обработать полученный запрос. Такое может произойти, когда вы указали неверный URL адрес, передали некорректные параметры или т.п. Формат ошибки стандартизирован. (Она одинакова для любых вызываемых методов API)

### Пример ответа с ошибкой
```
{
    "success": false,
    "error": {
        "code": 404,
        "message": "Unknown api method"
    }
}
```
- `error` Уникальный код ошибки, однозначно идентифицирующий проблему.
- `message` Произвольное, текстовое описание для тестировщика или разработчика системы.

### Коды ошибок
|Код|Описание|
|:-|:-|
|`404`|Неизвестный метод API. Проверьте правильность указанного URL адреса, на который отправляете запрос.|
|`500`|Внутренняя ошибка сервиса, причина неизвестна. Повторите попытку вызова или проверьте логи сервиса.|
|`2000`|Ошибка подписки, не указан тип события: `event`.|
|`2001`|Ошибка подписки, не указан адрес для обратного вызова: `callback`.|
|`2002`|Ошибка подписки, слушатель с такими: `event` и `callback` уже зарегистрирован.|
|`3000`|Ошибка разовой подписки, не указан тип события: `event`.|
|`3001`|Ошибка разовой подписки, не указан адрес для обратного вызова: `callback`.|
|`3002`|Ошибка разовой подписки, слушатель с такими: `event` и `callback` уже зарегистрирован.|
|`4000`|Ошибка отмены подписки, не указан тип события: `event`.|
|`4001`|Ошибка отмены подписки, не указан адрес обратного вызова: `callback`.|
|`4002`|Ошибка отмены подписки, слушатель с такими: `event` и `callback` не найден.|
|`5000`|Ошибка проверки подписки, не указан тип события: `event`.|
|`5001`|Ошибка проверки подписки, не указан адрес обратного вызова: `callback`.|
|`6000`|Ошибка отправки события, не указан тип события: `event`.|
|`6001`|Ошибка отправки события, параметры события в поле: `data` содержат некорректный JSON.|

## События
Событие - это строковой, уникальный идентификатор типа события и данные, связанные с ним. Сервис принимает запрос на рассылку события и отправляет его всем подписчикам.

### Тип события
Каждое событие имеет уникальный, строковой идентификатор. По соглашению, для имён событий должен использоваться [lowerCamelCase](https://en.wikipedia.org/wiki/Camel_case). Регистр важен.

### Параметры события
Данные события - это строка в формате JSON, которая может иметь произвольную структуру, зависящую от типа события. Данные события всегда передаются в **поисковых параметрах** запроса, не путать с данными **тела запроса**. События могут не иметь данных.
Примеры:
`/emit?event=newUser&data={"id":34, firstName:"Вася"}`
`/emit?event=restartUsersService`

## Список слушателей
Вы можете запросить у сервиса список всех слушателей в данный момент времени. Это может быть полезно для отладки или диагностики работы сервиса.

### Пример запроса
`GET` `/listener`

### Параметры
Нет

### Пример ответа
```
{
    "success": true,
    "results": [
        {
            "id": 56,
            "event": "newUser",
            "callback": "http://whois/onNewUser",
            "calls": 6,
            "errors": 29,
            "once": false,
            "dateCreated": 1615939112000,
            "dateLastCall": 1615966235000,
            "dateLastError": 1615966212000
        }
    ]
}
```
Возвращается список сущностей: `Listener`. Результат всегда является списком, даже если в ответе пустой массив или массив всего с одним элементом.
- `id` Уникальный идентификатор слушателя внутри сервиса.
- `event` Тип события, на которые подписан слушатель.
- `callback` URL Адрес для обратного вызова слушателя.
- `calls` Общее количество успешных вызовов слушателя за всё время его подписки.
- `errors` Общее количество неудачных попыток вызова слушателя за всё время его подписки.
- `once` Разовая подписка. Если `true`, подписчик автоматическии удаляется после первого вызова события.
- `dateCreated` Дата подписки в формате UNIX Timestamp. (Миллисекунды)
- `dateLastCall` Дата последнего, успешного вызова слушателя в формате UNIX Timestamp. (Миллисекунды)
- `dateLastError` Дата последней, неудачной попытки вызова слушателя в формате UNIX Timestamp. (Миллисекунды)

## Подписка на события
Метод позволяет подписаться на событие для получения обратного вызова в будущем. Вы должны указать Ваш URL адрес, на который будут производиться `POST` запросы с передачей [параметров события](#Параметры-события).

*п.с. Вы не можете добавить более одного слушателя на один тип события и с одинаковым адресом для обратного вызова. Это сделано для исключения вероятности возможных ошибок и переполнения сервиса идентичными подписчиками.*

### Пример запроса
`POST` `/on?event=newUser&callback=http://whois/onNewUser`

### Параметры
|Свойство|Обязательно|Описание|
|:-|:-:|:-|
|`event`|Да|Уникальный тип события, на который производится подписка.|
|`callback`|Да|URL Адрес для обратного вызова, на который будут переданы [параметры события](#Параметры-события) при его рассылке.|

### Пример ответа
```
{
    "success": true,
    "results": {
        "id": 90,
        "event": "newUser",
        "callback": "http://whois/onNewUser",
        "calls": 0,
        "errors": 0,
        "once": false,
        "dateCreated": 1615939112000,
        "dateLastCall": 0,
        "dateLastError": 0
    }
}
```
Возвращается единственное описание сущности: `Listener` для созданного слушателя.

## Разовая подписка на событие
Этот метод аналогичен обычной подписке с той разницей, что слушатель будет автоматически удалён после первого события. Полезно, когда нужно получить уведомление о событии только один раз.

### Пример запроса
`POST` `/once?event=restartUsersService&callback=http://whois/onRestartUsersService`

### Параметры
|Свойство|Обязательно|Описание|
|:-|:-:|:-|
|`event`|Да|Уникальный тип события, на который производится подписка.|
|`callback`|Да|URL Адрес для обратного вызова, на который будут переданы [параметры события](#Параметры-события) при его рассылке.|

### Пример ответа
```
{
    "success": true,
    "results": {
        "id": 91,
        "event": "restartUsersService",
        "callback": "http://whois/onRestartUsersService",
        "calls": 0,
        "errors": 0,
        "once": true,
        "dateCreated": 1615939112000,
        "dateLastCall": 0,
        "dateLastError": 0
    }
}
```
Возвращается единственное описание сущности: `Listener` для созданного слушателя.

## Отмена подписки
Позволяет отписаться от получаемых уведомлениях о событии. Сервис никогда не удаляет подписчиков самостоятельно, за исключением разовых подписок. Отмена подписки не влияет на рассылку событий, которые уже были начаты.

### Пример запроса
`POST` `/off?event=newUser&callback=http://whois/onNewUser`

### Параметры
|Свойство|Обязательно|Описание|
|:-|:-:|:-|
|`event`|Да|Уникальный тип события, на который оформлена подписка.|
|`callback`|Да|URL Адрес обратного вызова удаляемого подписчика.|

### Пример ответа
```
{
    "success": true,
    "results": {
        "id": 1876,
        "event": "newUser",
        "callback": "http://whois/onNewUser",
        "calls": 345,
        "errors": 21,
        "once": false,
        "dateCreated": 1615939112000,
        "dateLastCall": 1615939742000,
        "dateLastError": 1615939710000
    }
}
```
Возвращается единственное описание сущности: `Listener` для удалённого слушателя.

## Проверка наличия слушателя
Позволяет узнать, есть ли подписка для указанного слушателя.

### Пример запроса
`GET` `/has?event=newUser&callback=http://whois/onNewUser`

### Параметры
|Свойство|Обязательно|Описание|
|:-|:-:|:-|
|`event`|Да|Уникальный тип события, на который оформлена подписка.|
|`callback`|Да|URL Адрес обратного вызова проверяемого подписчика.|

### Пример ответа
```
{
    "success": true,
    "results": {
        "id": 1876,
        "event": "newUser",
        "callback": "http://whois/onNewUser",
        "calls": 345,
        "errors": 21,
        "once": false,
        "dateCreated": 1615939112000,
        "dateLastCall": 1615939742000,
        "dateLastError": 1615939710000
    }
}
```
Возвращает описание сущности: `Listener`, если подписка оформлена. Иначе возвращается: `null`.

## Рассылка события
Позволяет отправить событие и связанные с ним данные всем текущим подписчикам.

### Примеры запросов
`POST` `/emit?event=restartUsersService`
`POST` `/emit?event=newUser&data={"id":34, "firstName":"Вася"}`

### Параметры
|Свойство|Обязательно|Описание|
|:-|:-:|:-|
|`event`|Да|Уникальный тип рассылаемого события.|
|`data`|Нет|Параметры события. Если указано, должна быть строка в формате JSON.|

### Пример ответа
```
{
    "success": true,
    "results": true
}
```
Успешный ответ всегда возвращает логическое значение: `true`, что рассылка была начата.